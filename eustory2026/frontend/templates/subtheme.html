{% extends "base.html" %}

{% block content %}
<!-- TODO: Chat system -->

<h2 class="text-xl font-semibold text-gray-800 mb-4">Sous-th√®me</h2>
<h3 id="progress" class="text-gray-600 mb-6 italic">Chargement de la progression...</h3>

<div id="sections" class="space-y-6">
    <p class="text-gray-500 italic">Chargement des sections...</p>
</div>

<div id="form" class="mt-8"></div>
    

<script>
    const subthemeId = {{ id|escapejs }};
    
    // Simple token check and redirect
    function checkAndRedirect() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Votre session a expir√©. Veuillez vous reconnecter.');
            localStorage.removeItem('token');
            window.location.href = '/login';
            return true; // Return true to indicate redirect happened
        }
        return false;
    }
    
    // Check token on page load
    if (checkAndRedirect()) {
        // Stop execution if redirected
        return;
    }
    
    // Simple API request wrapper with error handling
    async function apiRequest(url, options = {}) {
        console.log(`üöÄ API Request: ${url}`); // Debug log
        
        // Add authorization header
        options.headers = {
            ...options.headers,
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        };
        
        try {
            const response = await fetch(url, options);
            console.log(`üì° API Response: ${response.status} ${response.statusText}`); // Debug log
            
            // If unauthorized, redirect to login
            if (response.status === 401) {
                console.error('‚ùå 401 Unauthorized - Token expired or invalid');
                alert('Votre session a expir√©. Veuillez vous reconnecter.');
                localStorage.removeItem('token');
                window.location.href = '/login';
                return null;
            }
            
            // Check for other error status codes
            if (!response.ok) {
                console.error(`‚ùå HTTP Error: ${response.status} ${response.statusText}`);
                const errorText = await response.text();
                console.error('Error details:', errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response;
        } catch (error) {
            console.error('üí• API request failed:', error);
            alert('Erreur de connexion. Veuillez v√©rifier votre connexion internet.\n\nD√©tails: ' + error.message);
            return null;
        }
    }

    // Show loading state
    const sectionsContainer = document.getElementById('sections');
    sectionsContainer.innerHTML = '<p class="text-gray-500 italic">Chargement des sections...</p>';
    
    console.log('üìã Loading sections for subtheme:', subthemeId);
    
    apiRequest(`/api/subthemes/?subtheme=${subthemeId}`, {})
    .then(res => {
        console.log('‚úÖ Sections API call successful');
        if (!res) {
            console.warn('‚ö†Ô∏è No response received');
            sectionsContainer.innerHTML = '<p class="text-red-500 italic">Erreur de chargement des sections.</p>';
            return;
        }
        return res.json();
    })
    .then(sections => {
        console.log('üìÑ Received sections:', sections);
        if (!sections) {
            console.warn('‚ö†Ô∏è No sections data');
            sectionsContainer.innerHTML = '<p class="text-red-500 italic">Aucune donn√©e re√ßue.</p>';
            return;
        }
        
        sectionsContainer.innerHTML = ""; // Clear loading message
        
        if (sections.length === 0) {
            sectionsContainer.innerHTML = "<p class=\"text-gray-500 italic\">Aucune section trouv√©e.</p>";
            return;
        }
        
        sections.forEach(section => {
            const div = document.createElement('div');
            div.className = 'bg-white p-5 rounded-lg shadow-sm border border-gray-200';

            div.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-800">${section.title}</h3>
                    <button onclick="showForm(${section.id})" class="bg-green-500 hover:bg-green-600 text-white font-medium py-1 px-3 rounded text-sm transition-colors">
                        + Ajouter
                    </button>
                </div>
                <div id="section-${section.id}" class="space-y-4"></div>
            `
            container.appendChild(div)

            loadContent(section.id)
        })
    })
    .catch(error => {
        console.error('üí• Failed to load sections:', error);
        sectionsContainer.innerHTML = '<p class="text-red-500 italic">Erreur de chargement des sections. Veuillez rafra√Æchir la page.</p>';
    });

    // Load progress
    const progressElement = document.getElementById('progress');
    progressElement.innerText = 'Chargement de la progression...';
    
    apiRequest(`/api/subthemes/${subthemeId}/progress/`, {})
    .then(res => {
        if (!res) return;
        return res.json();
    })
    .then(data => {
        if (data) {
            progressElement.innerText = `Progression: ${data.progress}%`;
        }
    })
    .catch(error => {
        console.error('Error loading progress:', error);
        progressElement.innerText = 'Impossible de charger la progression';
    });


    function loadContent(sectionId) {
        const container = document.getElementById(`section-${sectionId}`);
        container.innerHTML = "<p class=\"text-gray-500 italic\">Chargement du contenu...</p>";
        
        apiRequest(`/api/content/?section=${sectionId}`, {})
        .then(res => {
            if (!res) return;
            return res.json();
        })
        .then(blocks => {
            if (!blocks) return;
            
            container.innerHTML = "";

            if (blocks.length === 0) {
                container.innerHTML = "<p class=\"text-gray-500 italic\">Aucun contenu pour cette section.</p>";
            }

            blocks.forEach(block => {
                let html = "";
                console.log("Processing block:", block); // Debug log

                // Check content type (using English values from model)
                if (block.content_type === "text") {
                    html = `<p>${block.text || 'Aucun texte disponible'}</p>`;
                }
                else if (block.content_type === "image") {
                    if (block.image) {
                        // Use the local image URL
                        html = `<img src="${block.image}" width=200 class="rounded-lg shadow-sm">`;
                        if (block.image_url) {
                            html += `<p class="text-xs text-gray-400 mt-1">Source: ${block.image_url}</p>`;
                        }
                    } else if (block.image_url) {
                        // Fallback to original URL if local image failed to download
                        html = `<img src="${block.image_url}" width=200 class="rounded-lg shadow-sm border border-yellow-300">`;
                        html += `<p class="text-xs text-yellow-600 mt-1">‚ö†Ô∏è Image charg√©e depuis l'URL originale (t√©l√©chargement √©chou√©)</p>`;
                    } else {
                        html = `<p class="text-gray-500 italic">Image non disponible</p>`;
                    }
                    
                    // Show error messages if present in text
                    if (block.text && block.text.startsWith('[IMAGE DOWNLOAD ERROR]')) {
                        html += `<p class="text-xs text-red-600 mt-2 p-2 bg-red-50 rounded">${block.text.replace('[IMAGE DOWNLOAD ERROR] ', '')}</p>`;
                    }
                }
                else if (block.content_type === "quote") {
                    html = `<blockquote>${block.text || 'Aucune citation disponible'}</blockquote>`;
                }
                else {
                    html = `<p>Type de contenu inconnu: ${block.content_type}</p>`;
                }

                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200';
                div.innerHTML = `
                    <div class="text-sm text-gray-500 mb-2 italic">
                        Type: ${block.content_type}
                    </div>
                    ${html}
                    <div id='sources-${block.id}' class="mt-3 pt-3 border-t border-gray-200"></div>
                `;

                container.appendChild(div);

                loadSources(block.id);
            })
        })
        .catch(error => {
            console.error('Error loading content:', error);
        });
    }

    function loadSources(blockId) {
        const container = document.getElementById(`sources-${blockId}`);
        container.innerHTML = "<p class=\"text-xs text-gray-400 italic\">Chargement des sources...</p>";
        
        apiRequest(`/api/sources/?content_block=${blockId}`, {})
        .then(res => {
            if (!res) return;
            return res.json();
        })
        .then(sources => {
            if (!sources) return;
            
            container.innerHTML = ""; // Clear loading message

            if (sources.length === 0) {
                container.innerHTML = "<p class=\"text-xs text-gray-400 italic\">Aucune source.</p>";
                return;
            }

            sources.forEach(source => {
                const sourceElement = document.createElement('div');
                sourceElement.className = 'text-xs text-gray-500 mb-1';
                sourceElement.innerHTML = `
                    Source: ${source.author}, ${source.title} (${source.year})
                `;
                container.appendChild(sourceElement);
            })
        })
        .catch(error => {
            console.error('Error loading sources:', error);
            container.innerHTML = "<p class=\"text-xs text-red-500 italic\">Erreur de chargement des sources.</p>";
        });
    }


    function showForm(sectionId) {
        const form = document.getElementById("form")

        form.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Ajouter du contenu</h3>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type de contenu</label>
                    <select id="type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="text">Texte</option>
                        <option value="image">Image</option>
                        <option value="quote">Citation</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Texte</label>
                    <textarea id="text" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" rows="4"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">URL de l'image (pour les images)</label>
                    <input id="image" type="url" placeholder="https://example.com/image.jpg" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" pattern="https?://.+">
                    <p class="text-xs text-gray-500 mt-1">L'image sera t√©l√©charg√©e et sauvegard√©e localement</p>
                    <p class="text-xs text-gray-500 mt-1">‚ö†Ô∏è Utilisez une URL valide (ex: https://upload.wikimedia.org/wikipedia/commons/...)</p>
                </div>

                <button onclick="submitContent(${sectionId})" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                    Envoyer
                </button>
            </div>
        `;
    }

    function submitContent(sectionId) {
        const contentType = document.getElementById("type").value;
        const textContent = document.getElementById("text").value;
        const imageUrl = document.getElementById("image").value;

        // Client-side validation
        if (contentType === "image" && !imageUrl) {
            alert('‚ö†Ô∏è Veuillez fournir une URL d\'image pour le contenu de type image.');
            return;
        }

        if (contentType === "image" && imageUrl && !imageUrl.startsWith('http')) {
            alert('‚ö†Ô∏è L\'URL de l\'image doit commencer par http:// ou https://');
            return;
        }

        // Build the request body based on content type
        const requestBody = {
            section: sectionId,
            content_type: contentType,
            text: textContent
        };

        // For images, include the image URL (will be downloaded by the server)
        if (contentType === "image" && imageUrl) {
            requestBody.image_url = imageUrl;
        }

        console.log('Submitting content:', requestBody); // Debug log

        const response = await apiRequest('/api/content/', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            throw new Error('Failed to submit content');
        }
        return response;
        .then(response => {
            console.log('Response status:', response.status); // Debug log
            if (!response.ok) {
                return response.json().then(err => {
                    console.error('Detailed error:', err);
                    throw new Error('Failed to submit content: ' + (err.detail || JSON.stringify(err)));
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Content created:', data); // Debug log
            loadContent(sectionId);
            // Clear the form
            document.getElementById("form").innerHTML = "";
            // Show success message
            alert('Contenu ajout√© avec succ√®s !');
        })
        .catch(error => {
            console.error('Error submitting content:', error);
            alert('Erreur lors de l\'ajout du contenu: ' + error.message);
        });
    }
</script>

{% endblock %}