{% extends "base.html" %}

{% block content %}

<h2 class="text-xl font-semibold text-gray-800 mb-4">Sous-th√®me</h2>
<h3 id="progress" class="text-gray-600 mb-6 italic">Chargement de la progression...</h3>

<div id="sections" class="space-y-6">
    <p class="text-gray-500 italic">Chargement des sections...</p>
</div>

<div id="form" class="mt-8"></div>

<script>
    // SubTheme App - Modern Class-Based Approach
    class SubThemeApp {
        constructor(subthemeId) {
            this.subthemeId = subthemeId;
            this.token = localStorage.getItem('token');
            
            // Check token on initialization
            if (!this.token) {
                this.redirectToLogin('Votre session a expir√©. Veuillez vous reconnecter.');
                return;
            }
            
            // Initialize the app
            this.init();
        }
        
        redirectToLogin(message) {
            alert(message);
            localStorage.removeItem('token');
            window.location.href = '/login';
        }
        
        async makeApiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        ...options.headers,
                        'Authorization': `Bearer ${this.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    this.redirectToLogin('Votre session a expir√©. Veuillez vous reconnecter.');
                    return null;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        async loadSections() {
            const container = document.getElementById('sections');
            container.innerHTML = '<p class="text-gray-500 italic">Chargement des sections...</p>';
            
            try {
                console.log(`üìã Loading sections for subtheme ID: ${this.subthemeId}`);
                const sections = await this.makeApiRequest(`/api/subthemes/?subtheme=${this.subthemeId}`);
                
                console.log('üìÑ Received sections data:', sections);
                
                if (!sections || sections.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic">Aucune section trouv√©e.</p>';
                    return;
                }
                
                container.innerHTML = '';
                sections.forEach(section => this.renderSection(section));
                
            } catch (error) {
                console.error('‚ùå Failed to load sections:', error);
                container.innerHTML = `<p class="text-red-500 italic">Erreur de chargement: ${error.message}</p>`;
                throw error; // Re-throw to be caught by init()
            }
        }
        
        renderSection(section) {
            const container = document.getElementById('sections');
            const div = document.createElement('div');
            div.className = 'bg-white p-5 rounded-lg shadow-sm border border-gray-200';
            
            div.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-800">${section.title}</h3>
                    <button onclick="app.showForm(${section.id})" class="bg-green-500 hover:bg-green-600 text-white font-medium py-1 px-3 rounded text-sm transition-colors">
                        + Ajouter
                    </button>
                </div>
                <div id="section-${section.id}" class="space-y-4"></div>
            `;
            
            container.appendChild(div);
            this.loadContent(section.id);
        }
        
        async loadContent(sectionId) {
            const container = document.getElementById(`section-${sectionId}`);
            container.innerHTML = '<p class="text-gray-500 italic text-sm">Chargement du contenu...</p>';
            
            try {
                const blocks = await this.makeApiRequest(`/api/content/?section=${sectionId}`);
                
                if (!blocks || blocks.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic text-sm">Aucun contenu.</p>';
                    return;
                }
                
                container.innerHTML = '';
                blocks.forEach(block => this.renderContentBlock(block));
                
            } catch (error) {
                console.error('Failed to load content:', error);
                container.innerHTML = `<p class="text-red-500 italic text-sm">Erreur: ${error.message}</p>`;
            }
        }
        
        renderContentBlock(block) {
            const container = document.getElementById(`section-${block.section}`);
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200';
            
            let contentHtml = '';
            if (block.content_type === 'text') {
                contentHtml = `<p>${block.text || 'Aucun texte'}</p>`;
            } else if (block.content_type === 'image') {
                if (block.image) {
                    contentHtml = `<img src="${block.image}" class="rounded-lg shadow-sm max-w-full h-auto">`;
                } else if (block.image_url) {
                    contentHtml = `<img src="${block.image_url}" class="rounded-lg shadow-sm max-w-full h-auto border border-yellow-300">`;
                } else {
                    contentHtml = '<p class="text-gray-500 italic">Image non disponible</p>';
                }
            } else if (block.content_type === 'quote') {
                contentHtml = `<blockquote class="border-l-4 border-gray-300 pl-4 italic">${block.text || 'Aucune citation'}</blockquote>`;
            }
            
            div.innerHTML = `
                <div class="text-xs text-gray-500 mb-2 italic">Type: ${block.content_type}</div>
                ${contentHtml}
                <div id="sources-${block.id}" class="mt-2 pt-2 border-t border-gray-200"></div>
            `;
            
            container.appendChild(div);
            this.loadSources(block.id);
        }
        
        async loadSources(blockId) {
            const container = document.getElementById(`sources-${blockId}`);
            container.innerHTML = '<p class="text-xs text-gray-400 italic">Chargement des sources...</p>';
            
            try {
                const sources = await this.makeApiRequest(`/api/sources/?content_block=${blockId}`);
                
                if (!sources || sources.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-400 italic">Aucune source</p>';
                    return;
                }
                
                container.innerHTML = '';
                sources.forEach(source => {
                    const sourceDiv = document.createElement('div');
                    sourceDiv.className = 'text-xs text-gray-500 mb-1';
                    sourceDiv.innerHTML = `Source: ${source.author}, ${source.title} (${source.year})`;
                    container.appendChild(sourceDiv);
                });
                
            } catch (error) {
                console.error('Failed to load sources:', error);
                container.innerHTML = `<p class="text-xs text-red-500 italic">Erreur: ${error.message}</p>`;
            }
        }
        
        async loadProgress() {
            const progressElement = document.getElementById('progress');
            progressElement.innerText = 'Chargement de la progression...';
            
            try {
                const data = await this.makeApiRequest(`/api/subthemes/${this.subthemeId}/progress/`);
                if (data && data.progress !== undefined) {
                    progressElement.innerText = `Progression: ${data.progress}%`;
                } else {
                    progressElement.innerText = 'Progression: 0%';
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
                progressElement.innerText = 'Impossible de charger la progression';
            }
        }
        
        showForm(sectionId) {
            const formContainer = document.getElementById('form');
            formContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Ajouter du contenu</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type de contenu</label>
                        <select id="content-type" onchange="app.updateFormFields()" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="text">Texte</option>
                            <option value="image">Image</option>
                            <option value="quote">Citation</option>
                        </select>
                    </div>
                    
                    <!-- Text field (always visible) -->
                    <div id="text-field" class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Texte</label>
                        <textarea id="content-text" class="w-full p-2 border border-gray-300 rounded-md" rows="4" placeholder="Entrez votre texte ici..."></textarea>
                    </div>
                    
                    <!-- Image URL field (hidden by default) -->
                    <div id="image-field" class="mb-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">URL de l'image</label>
                        <input id="content-image" type="url" placeholder="https://example.com/image.jpg" class="w-full p-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">URL compl√®te de l'image √† t√©l√©charger</p>
                    </div>
                    
                    <!-- Source field (always visible, required) -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Source <span class="text-red-500">*</span>
                        </label>
                        <input id="content-source" type="url" placeholder="https://example.com/source" 
                               class="w-full p-2 border border-gray-300 rounded-md" required>
                        <p class="text-xs text-gray-500 mt-1">URL de la source (obligatoire pour toutes les citations)</p>
                    </div>
                    
                    <button onclick="app.submitContent(${sectionId})" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md">
                        Envoyer
                    </button>
                </div>
            `;
            
            // Set initial form state based on content type
            this.updateFormFields();
        }
        
        updateFormFields() {
            const contentType = document.getElementById('content-type').value;
            const textField = document.getElementById('text-field');
            const imageField = document.getElementById('image-field');
            const textInput = document.getElementById('content-text');
            
            // Always show text field, but adjust placeholder based on type
            textField.classList.remove('hidden');
            
            // Show/hide image field based on content type
            if (contentType === 'image') {
                imageField.classList.remove('hidden');
                textInput.placeholder = 'Description de l\'image (optionnel)';
            } else {
                imageField.classList.add('hidden');
                
                if (contentType === 'quote') {
                    textInput.placeholder = 'Entrez la citation ici...';
                } else {
                    textInput.placeholder = 'Entrez votre texte ici...';
                }
            }
        }

        showForm(sectionId) {
            const formContainer = document.getElementById('form');
            formContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Ajouter du contenu</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type de contenu</label>
                        <select id="content-type" onchange="app.updateFormFields()" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="text">Texte</option>
                            <option value="image">Image</option>
                            <option value="quote">Citation</option>
                        </select>
                    </div>
                    
                    <!-- Text field (always visible) -->
                    <div id="text-field" class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Texte</label>
                        <textarea id="content-text" class="w-full p-2 border border-gray-300 rounded-md" rows="4" placeholder="Entrez votre texte ici..."></textarea>
                    </div>
                    
                    <!-- Image URL field (hidden by default) -->
                    <div id="image-field" class="mb-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">URL de l'image</label>
                        <input id="content-image" type="url" placeholder="https://example.com/image.jpg" class="w-full p-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">URL compl√®te de l'image √† t√©l√©charger</p>
                    </div>
                    
                    <!-- Source field (always visible, required) -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Source <span class="text-red-500">*</span>
                        </label>
                        <input id="content-source" type="url" placeholder="https://example.com/source" 
                               class="w-full p-2 border border-gray-300 rounded-md" required>
                        <p class="text-xs text-gray-500 mt-1">URL de la source (obligatoire pour toutes les citations)</p>
                    </div>
                    
                    <button onclick="app.submitContent(${sectionId})" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md">
                        Envoyer
                    </button>
                </div>
            `;
            
            // Set initial form state based on content type
            this.updateFormFields();
        }
        
        updateFormFields() {
            const contentType = document.getElementById('content-type').value;
            const textField = document.getElementById('text-field');
            const imageField = document.getElementById('image-field');
            const textInput = document.getElementById('content-text');
            
            // Always show text field, but adjust placeholder based on type
            textField.classList.remove('hidden');
            
            // Show/hide image field based on content type
            if (contentType === 'image') {
                imageField.classList.remove('hidden');
                textInput.placeholder = 'Description de l\'image (optionnel)';
            } else {
                imageField.classList.add('hidden');
                
                if (contentType === 'quote') {
                    textInput.placeholder = 'Entrez la citation ici...';
                } else {
                    textInput.placeholder = 'Entrez votre texte ici...';
                }
            }
        }
        
        async submitContent(sectionId) {
            const contentType = document.getElementById('content-type').value;
            const text = document.getElementById('content-text').value;
            const imageUrl = document.getElementById('content-image').value;
            const sourceUrl = document.getElementById('content-source').value;
            
            // Validate source URL is provided
            if (!sourceUrl) {
                alert('‚ö†Ô∏è Veuillez fournir une URL de source.');
                return;
            }
            
            const payload = {
                section: sectionId,
                content_type: contentType,
                text: text
            };
            
            if (contentType === 'image' && imageUrl) {
                payload.image_url = imageUrl;
            }
            
            try {
                const response = await fetch('/api/content/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to submit: ${errorText}`);
                }
                
                const contentBlock = await response.json();
                
                // Now create the source for this content block
                await this.createSource(contentBlock.id, sourceUrl);
                
                // Clear form and reload content
                document.getElementById('form').innerHTML = '';
                this.loadContent(sectionId);
                alert('Contenu ajout√© avec succ√®s!');
                
            } catch (error) {
                console.error('Submit failed:', error);
                alert(`Erreur: ${error.message}`);
            }
        }
        
        async createSource(contentBlockId, sourceUrl) {
            try {
                const response = await fetch('/api/sources/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_block: contentBlockId,
                        source_type: 'website',
                        author: 'Utilisateur',
                        title: 'Source utilisateur',
                        url: sourceUrl,
                        year: new Date().getFullYear().toString()
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to create source:', errorText);
                    // Don't fail the whole operation if source creation fails
                }
                
            } catch (error) {
                console.error('Source creation failed:', error);
                // Don't fail the whole operation if source creation fails
            }
        }

        async submitContent(sectionId) {
            const contentType = document.getElementById('content-type').value;
            const text = document.getElementById('content-text').value;
            const imageUrl = document.getElementById('content-image').value;
            const sourceUrl = document.getElementById('content-source').value;
            
            // Validate source URL is provided
            if (!sourceUrl) {
                alert('‚ö†Ô∏è Veuillez fournir une URL de source.');
                return;
            }
            
            const payload = {
                section: sectionId,
                content_type: contentType,
                text: text
            };
            
            if (contentType === 'image' && imageUrl) {
                payload.image_url = imageUrl;
            }
            
            try {
                const response = await fetch('/api/content/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to submit: ${errorText}`);
                }
                
                const contentBlock = await response.json();
                
                // Now create the source for this content block
                await this.createSource(contentBlock.id, sourceUrl);
                
                // Clear form and reload content
                document.getElementById('form').innerHTML = '';
                this.loadContent(sectionId);
                alert('Contenu ajout√© avec succ√®s!');
                
            } catch (error) {
                console.error('Submit failed:', error);
                alert(`Erreur: ${error.message}`);
            }
        }
        
        async createSource(contentBlockId, sourceUrl) {
            try {
                const response = await fetch('/api/sources/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_block: contentBlockId,
                        source_type: 'website',
                        author: 'Utilisateur',
                        title: 'Source utilisateur',
                        url: sourceUrl,
                        year: new Date().getFullYear().toString()
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to create source:', errorText);
                    // Don't fail the whole operation if source creation fails
                }
                
            } catch (error) {
                console.error('Source creation failed:', error);
                // Don't fail the whole operation if source creation fails
            }
        }
        
        async init() {
            try {
                console.log('üöÄ Initializing SubTheme App...');
                
                // Load all data with error handling
                await Promise.all([
                    this.loadSections().catch(error => {
                        console.error('‚ùå Sections loading failed:', error);
                        throw error;
                    }),
                    this.loadProgress().catch(error => {
                        console.error('‚ùå Progress loading failed:', error);
                        throw error;
                    })
                ]);
                
                console.log('‚úÖ SubTheme App initialized successfully');
            } catch (error) {
                console.error('üí• App initialization failed:', error);
                const sectionsContainer = document.getElementById('sections');
                sectionsContainer.innerHTML = `
                    <p class="text-red-500 italic">Erreur de chargement de la page.</p>
                    <p class="text-sm text-gray-600">D√©tails: ${error.message}</p>
                    <button onclick="window.location.reload()" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm">
                        R√©essayer
                    </button>
                `;
            }
        }
    }
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        window.app = new SubThemeApp({{ id|escapejs }});
    });
</script>

{% endblock %}